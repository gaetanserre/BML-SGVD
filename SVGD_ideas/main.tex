\documentclass[runningheads,a4paper]{llncs}

\setcounter{tocdepth}{3}
\usepackage{natbib}
\usepackage[english]{babel}
\usepackage{graphicx}
\usepackage{subcaption}
\usepackage{algorithm}
\usepackage{algpseudocode}
\usepackage{amsmath, amssymb, mathtools, amsthm}
\usepackage{hyperref}
\usepackage{url}
\usepackage[pages=some]{background}
\usepackage[margin=2.8cm]{geometry}
\usepackage{lipsum}
\graphicspath{{figures/}}
\definecolor{MVA}{HTML}{652475}

\newcommand\BackGroundImage[1]{%
\BgThispage
\backgroundsetup{
    scale=1,angle=0,position={current page.north}, hshift=-7.5cm, 
    vshift=-1.5cm, opacity=1,
    contents={%
    \includegraphics[width=5cm]{#1}
}}}

\newcommand{\R}{\mathbb{R}}
\newcommand{\E}{\mathbb{E}}
\newcommand{\Sr}{\mathbb{S}}
\newcommand{\X}{\mathcal{X}}
\newcommand{\A}{\mathcal{A}}
\newcommand{\Hr}{\mathcal{H}}
\newcommand{\diff}[2]{\frac{\partial #1}{\partial #2}}
\DeclarePairedDelimiter{\norm}{\|}{\|}
\DeclarePairedDelimiter{\pare}{(}{)}
\DeclarePairedDelimiter{\bra}{\{}{\}}
\DeclarePairedDelimiter{\sq}{[}{]}
\DeclarePairedDelimiter{\sca}{\langle}{\rangle}
\renewcommand\qedsymbol{$\blacksquare$}

\begin{document} 

\mainmatter
\titlerunning{Stein Variational Gradient Descent: Main ideas}
\title{Stein Variational Gradient Descent: Main ideas}

\author{Gaëtan Serré}
\authorrunning{Serré}

\institute{École Normale Supérieure Paris-Saclay\\
Master Mathématiques, Vision, Apprentissage\\
gaetan.serre@ens-paris-saclay.fr}

\toctitle{Stein Variational Gradient Descent: Main ideas}
\tocauthor{Gaëtan Serré}
\maketitle

\BackGroundImage{MVA.pdf}

\section{Goal}
Given a smooth density $\pi$ supported on $\X \subseteq \R^d$,
find $\mu$ on $\X$ as close as possible to $\pi$.

\section{Stein framework}
\paragraph{\bf Stein identity:}
Let $\A_\mu$ a Stein operator s.t.
$$
\A_\mu \phi = \nabla \log \mu(\cdot)^\top \phi(\cdot) + \nabla \cdot \phi(\cdot)
$$
with $\phi(x) = [\phi_1(x), ..., \phi_d(x)]^\top$.
Then, if $\phi$ is in the Stein class of $\mu$ i.e. $\phi(x)\mu(x) = \vec{0}$ for all $x \in \partial \X$
if $\X$ is compact or $\lim_{||x|| \to \infty} \phi(x) \mu(x) = \vec{0}$ if $\X = \R^d$, we have:
\begin{equation}
  \E_{x \sim \pi}[\A_\mu \phi (x)] = 0
  \label{eq:stein_id}
\end{equation}
\begin{proof}
  \begin{align*}
    \E_{x \sim \mu}[\A_\mu \phi (x)] &=
      \int_\X \pare*{ \nabla \log \mu(\cdot)^\top \phi(\cdot) + \nabla \cdot \phi(\cdot) } \mu(x) dx \\
    &= \int_\X \nabla \log \mu(\cdot)^\top \phi(\cdot) \mu(x) dx + \int_\X \nabla \cdot \phi(\cdot) \mu(x) dx \\
    &= \int_\X \nabla \log \mu(\cdot)^\top \phi(\cdot) \mu(x) dx +
      \int_\X \sum_{k=1}^d \diff{\phi_k}{x_k} \mu(x) dx \\
    &= \int_\X \nabla \log \mu(\cdot)^\top \phi(\cdot) \mu(x) dx +
    \sum_{k=1}^d \pare*{ \sq*{\mu(x) \phi_k(x)}_\X - \int_\X \diff{\mu(x)}{x_k} \phi_k(x) dx} \\
    &= \int_\X \nabla \log \mu(\cdot)^\top \phi(\cdot) \mu(x) dx -
      \int_\X \sum_{k=1}^d \diff{\mu(x)}{x_k} \phi_k(x) dx \\
    &= \int_\X  \mu(x) \sum_{k=1}^d \diff{\log \mu(x)}{x_k}\phi_k(x) -
    \mu(x) \sum_{k=1}^d \diff{\log \mu(x)}{x_k} \phi_k(x) dx \;\; \text{(log trick)} \\
    &= 0
  \end{align*}
\end{proof}

Now, let $\pi$ a smooth density supported on $\X$ different from $\mu$. Now, Eq.~\ref{eq:stein_id} do not hold
anymore with $\A_\pi$. However, we can use $\E_{x \sim \mu}[\A_\pi \phi (x)]$ as a discrepancy
measure between $\mu$ and $\pi$, as its magnitude relates to how different $\mu$ and $\pi$ are
(see \cite{https://doi.org/10.48550/arxiv.1608.04471} \& \cite{https://doi.org/10.48550/arxiv.1704.07520}).
Indeed, we have:
\begin{equation}
  \begin{split}
    \E_{x \sim \mu}[\A_\pi \phi (x)] &=
      \int_\X \pare*{ \nabla \log \pi(x)^\top \phi(x) + \nabla \cdot \phi(x) } \mu(x) dx \\
    &= \int_\X \nabla \log \pi(x)^\top \phi(x) \mu(x) dx +
    \sum_{k=1}^d \pare*{ \sq*{\mu(x) \phi_k(x)}_\X - \int_\X \diff{\mu(x)}{x_k} \phi_k(x) dx} \\
    &= \int_\X  \mu(x) \sum_{k=1}^d \diff{\log \pi(x)}{x_k}\phi_k(x) -
    \mu(x) \sum_{k=1}^d \diff{\log \mu(x)}{x_k} \phi_k(x) dx \;\; \text{(log trick)} \\
    &= \int_\X  \mu(x) \sq*{ \sum_{k=1}^d \phi_k(x) \pare*{ \diff{\log \pi(x)}{x_k} - \diff{\log \mu(x)}{x_k}}} dx \\
    &= \int_\X  \mu(x) \sq*{ \sum_{k=1}^d \phi_k(x) \pare*{ \diff{\log \frac{\pi(x)}{\mu(x)}}{x_k}}} dx.
  \end{split}
\end{equation}
As expected, the scale of $\E_{x \sim \mu}[\A_\pi \phi (x)]$ increases w.r.t. the difference between $\mu$ and $\pi$.\\

Therefore, one can define an objective to find a density $\mu^*$ close to $\pi$:
\begin{equation}
  \mu^* = \arg\min_{\mu} \: \Sr(\mu, \pi) =
    \arg\min_{\mu} \: \max_{\phi \in \Hr} \bra*{ \E_{x \sim \mu}[\A_\pi \phi (x)] },
  \label{eq:stein_obj}
\end{equation}
as $\Sr(\mu, \pi) = 0$ iff $\mu = \pi$ and $\Sr(\mu, \pi) > 0$ otherwise with $\Hr$ sufficiently large.
The choice of $\Hr$ is therefore crucial. One way to ensure it is both rich enough and computationally tractable
is to let $\Hr$ be a RKHS.

\subsection{Kernelized Stein Discrepancy}\label{sec:ksd}
Let $\Hr_0$ be a RKHS with a kernel $k(x, x')$ in the Stein class of $\mu$.
Let $\Hr = (\Hr^{(1)}_0, \dots, \Hr^{(d)}_0)$. The KSD maximizes $\phi$ in the unit ball of $\Hr$.
The objective in (\ref{eq:stein_obj}) is then:
\begin{equation}
  \Sr(\mu, \pi) =
    \max_{\phi \in \Hr} \bra*{ \E_{x \sim \mu}[\A_\pi \phi (x)], \; s.t. \; \|\phi\|_{\Hr} \leq 1 }.
  \label{eq:stein_ksd_obj}
\end{equation}
Within this framework, one can show that the optimal solution of (\ref{eq:stein_ksd_obj})
is given by:
\begin{equation}
  \phi(x) = \frac{\phi^*(x)}{\|\phi^*\|_{\Hr}}
    \text{ , where } \phi^*(.) = \E_{x \sim \mu}\sq*{ \A_\pi \otimes k(x, \cdot) }
                               = \int_\X k(x, \cdot) \nabla \log \pi(x) + \nabla k(x, \cdot) d\mu(x),
  \label{eq:stein_ksd_sol}        
\end{equation}
where $\A_\pi \otimes f(x) = f(x) \nabla \log \pi(x) + \nabla f(x)$, is a variant of Stein operator.
We also know that $\phi^*$ is in the Stein class of $\mu$ as $k$ is.
Moreover, $\Sr(\mu, \pi) = \|\phi^*\|_\Hr$.
\begin{proof}
  We first need to prove that
  $$
  \E_{x \sim \mu} \sq*{ \A_\pi f(x) } = \sca*{f, \phi^*}_\Hr, \; \forall f \in \Hr:
  $$
  \begin{equation}
    \begin{split}
      \sca*{f, \phi^*}_\Hr &= \sum_{l=1}^d \sca*{ f^{(l)},
        \E_{x \sim \mu}\sq*{ k(x, \cdot) \nabla \log \pi(x)^{(l)} + \nabla k(x, \cdot)^{(l)}} }_{\Hr^0} \\
        &= \E_{x \sim \mu}\sq*{ \sum_{l=1}^d \sca*{f^{(l)}, k(x, \cdot)
          \nabla \log \pi(x)^{(l)} + \nabla k(x, \cdot)^{(l)} }_{\Hr^0} } \\
        &= \E_{x \sim \mu}\sq*{ \sum_{l=1}^d \nabla \log \pi(x)^{(l)}
          \sca*{ f^{(l)}, k(x, \cdot) }_{\Hr^0} + \sca*{ f^{(l)}, \nabla k(x, \cdot)^{(l)} }_{\Hr^0} } \\
        &= \E_{x \sim \mu}\sq*{ \sum_{l=1}^d \nabla \log \pi(x)^{(l)} f^{(l)}(x) + \nabla_{x_l} f(x)^{(l)} }
         \text{ (see \cite{Zhou2008}) } \\
        &= \E_{x \sim \mu}\sq*{ \nabla \log \pi(x)^\top f(x) + \nabla \cdot f(x) } \\
        &= \E_{x \sim \mu} \sq*{ \A_\pi f(x) }.
    \end{split}
  \end{equation}
  Moreover, $\sca*{ f, \phi* }_\Hr \leq \norm{f}_\Hr \norm{\phi^*}_\Hr$.
  Thus,
  $$
  \Sr(\mu, \pi) =
    \max_{f \in \Hr} \bra*{ \E_{x \sim \mu}[\A_\pi f (x)] = \sca*{f, \phi^*}_\Hr, \; s.t. \; \|f\|_{\Hr} \leq 1 }
    \leq \norm{\phi^*}_\Hr.
  $$
  Let $f = \frac{\phi^*}{\norm{\phi^*}_\Hr}$, then $\norm{f}_\Hr = 1$ and
  $$
  \E_{x \sim \mu}[\A_\pi \phi (x)] = \sca*{f, \phi^*}_\Hr = \norm{\phi^*}_\Hr,
  $$
  ending the proof.
\end{proof}

\section{Link with Kullback-Leibler Divergence}
Let $T: \X \to \X$, $x \mapsto (I + \gamma \phi)(x)$. One can show that
(see \cite{https://doi.org/10.48550/arxiv.1608.04471} Theorem 3.1):
\begin{equation}
  \nabla_\gamma KL(T_\#\mu || \pi) = -\E_{x \sim \mu}[\A_\pi \phi(x)].
  \label{eq:grad_kl}
\end{equation}
Therefore, assuming $\phi \in \Hr$ with $\Hr$ as defined as in Section~\ref{sec:ksd},
using (\ref{eq:stein_ksd_sol}), we know that:
\begin{equation}
  \phi^*(.) = \int_\X k(x, \cdot) \nabla \log \pi(x) + \nabla k(x, \cdot) d\mu(x)
\end{equation}
minimizes $\nabla_\gamma KL(T_\#\mu || \pi)$.
Furthermore, one can show that:
\begin{equation}
  \begin{split}
    P_\mu \nabla \log \frac{\mu}{\pi} (\cdot) &=
      \int_\X k(x, \cdot) \nabla \log \mu(x) d\mu(x) - \int_\X k(x, \cdot) \nabla \log \pi (x) d\mu(x) \\
    &= \int_\X k(x, \cdot) \nabla \mu(x) dx - \int_\X k(x, \cdot) \nabla \log \pi (x) d\mu(x) \\
    &= - \int_\X \nabla k(x, \cdot) d\mu(x) - \int_\X k(x, \cdot) \nabla \log \pi (x) d\mu(x) \\
    &= - \int_\X k(x, \cdot) \nabla \log \pi (x) + \nabla k(x, \cdot) d\mu(x) \\
    &= -\phi^*(\cdot)
  \end{split}
\end{equation}
The Stein Variational Gradient Descent (SVGD) algorithm consists
in an iterative procedure where one apply successive transformations
to an initial density $\mu_0$ towards
the "direction" $\phi^*$ that minimizes the gradient of the Kullback-Leibler divergence:
\begin{equation}
  \mu_{n+1} = \pare*{ I + \gamma \phi^* }_\# \mu_n = \pare*{ I - \gamma P_\mu \nabla \log \frac{\mu}{\pi} }_\# \mu_n.
\end{equation}

\section{Not understood yet}
\begin{itemize}
  \item Link with Wasserstein distance?
  \item Why did they defined so much about their RKHS?
\end{itemize}

\bibliography{refs}
\bibliographystyle{plainnat}

\appendix
\section{Lemmas}
\begin{lemma}
  Let two distributions $\mu$ and $\pi$ on $\X \subseteq \R^d$.
  Let $\phi: \X \to \R^d$ be in the Stein class of $\mu$ and
  $\A_\pi \phi(x) = \nabla \log \pi(x)^\top \phi(x) + \nabla \cdot \phi(x)$ Then,
  $$
  \E_{x \sim \mu}\sq*{ \A_\pi \phi(x) } =
    \E_{x \sim \mu}\sq*{ \pare*{\nabla \log \pi(x) - \nabla \log \mu(x)}^\top \phi(x) }
  $$
  \begin{proof}
    \begin{align*}
      \E_{x \sim \mu}\sq*{ \A_\pi \phi(x) } &= \E_{x \sim \mu}\sq*{ \A_\pi \phi(x) - \A_\mu \phi(x) } \\
      &= \E_{x \sim \mu}\sq*{ \nabla \log \pi(x)^\top \phi(x) - \nabla \cdot \phi(x) -
      \nabla \log \mu(x)^\top \phi(x) + \nabla \cdot \phi(x) } \\
      &= \E_{x \sim \mu}\sq*{ \pare*{\nabla \log \pi(x) - \nabla \log \mu(x)}^\top \phi(x) }
    \end{align*}
  \end{proof}
  \label{lem:stein_op}
\end{lemma}

\begin{lemma}
  Let two distributions $\mu$ and $\pi$ on $\X \subseteq \R^d$.
  Let $\phi: \X \to \R$ be in the Stein class of $\mu$ and
  $\A_\pi \otimes \phi(x) = \phi(x) \nabla \log \pi(x) + \nabla \phi(x)$ Then,
  $$
  \E_{x \sim \mu}\sq*{ \A_\pi \otimes \phi(x) } =
    \E_{x \sim \mu}\sq*{ \pare*{\nabla \log \pi(x) - \nabla \log \mu(x)} \phi(x) }
  $$
  \begin{proof}
    Same as Lemma~\ref{lem:stein_op}.
  \end{proof}
  \label{lem:stein_op_scalar}
\end{lemma}


\end{document} 
